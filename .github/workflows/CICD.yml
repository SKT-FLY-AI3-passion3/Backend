name: Build and Deploy Docker Image
on:
  push:
    branches:
      - main  

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'corretto'
        java-version: '17'

    - name: Grant execute permission to gradlew
      run: chmod +x ./gradlew
    
    - name: Build Spring Boot application
      run: ./gradlew clean build  # 또는 해당 빌드 명령어로 변경

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}  # GitHub Secrets에 설정한 사용자명
        password: ${{ secrets.DOCKERHUB_TOKEN }}     # GitHub Secrets에 설정한 액세스 토큰

    - name: Restore keystore.p12 from secrets
      run: |
        echo "${{ secrets.KEYSTORE_P12_CONTENT }}" | base64 -d > keystore.p12

    - name: Create sensitive files from secrets
      run: |
        echo "${{ secrets.VAULTED_FORT_CONTENT }}" > vaulted-fort-358506-3f5080aabb57.json
        echo "${{ secrets.APPLICATION_DEFAULT_CREDENTIALS_CONTENT }}" > application_default_credentials.json

    - name: Build and push Docker image
      run: |
        docker build -t jaehyuk00/passin3backend:${{ github.sha }} .
        docker tag jaehyuk00/passin3backend:${{ github.sha }} jaehyuk00/passin3backend:latest
        docker push jaehyuk00/passin3backend:${{ github.sha }}
        docker push jaehyuk00/passin3backend:latest
